<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.0/async.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>  
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <title>Covid-19 Projection in Nepal</title>
    </head>
    <body>
      <div class="dropdown" align="center">
        <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Select Region
        <span class="caret"></span></button>
        <ul class="dropdown-menu">
          <li><a href="#" onclick="toggleRegion('Whole Nepal');">National</a></li>
          <li><a href="#" onclick="toggleRegion('Province-1');">Province 1</a></li>
          <li><a href="#" onclick="toggleRegion('Province-2');">Province 2</a></li>
          <li><a href="#" onclick="toggleRegion('Province-3');">Province 3</a></li>
          <li><a href="#" onclick="toggleRegion('Province-4');">Province 4</a></li>
          <li><a href="#" onclick="toggleRegion('Province-5');">Province 5</a></li>
          <li><a href="#" onclick="toggleRegion('Province-6');">Province 6</a></li>
          <li><a href="#" onclick="toggleRegion('Province-7');">Province 7</a></li>
        </ul>
      </div>
    </div>

      <div class="container">
          <canvas id="myChart"></canvas>
      </div>
      <div class="container">
          <canvas id="myChart2"></canvas>
      </div>
      <div class="container">
        <canvas id="myChart3"></canvas>
    </div>
    <div class="container">
        <canvas id="myChart4"></canvas>
    </div>

    <script>

    toggleRegion('National')
    
    function toggleRegion(region) {
      plotChartType('Infected', region, 'infected', 'myChart');
      plotChartType('Deaths', region, 'chilam', 'myChart2');
      plotChartType('DeathsPerDay', region, 'chilamPerDay', 'myChart3');
      plotChartType('Recovered', region, 'recovered', 'myChart4');
    }


    function plotChartType(name, region, data_type_in_csv, plot_id){
      // Get national infected:
    var data_no_mitigation = [];
    var data_50_mitigation = [];
    var data_75_mitigation = [];
    var data_90_mitigation = [];

    function readCSV(name, store_at, callback) {
      console.log("called read csv");
      d3.csv(name).then(function(data) {
      data.forEach(function(d) {
        let x = +d.day;
        let y = +d[data_type_in_csv]/1000;
        store_at.push({x: x,y: y});
      });
      callback();
      });
   }
  
  async.parallel([
    function(callback) { readCSV('/scripts/data/'+region+'_No.csv', data_no_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_50.csv', data_50_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_75.csv', data_75_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_90.csv', data_90_mitigation, callback); }
  ], function done(err, results) {
    console.log("loaded all csv");
    console.log(data_no_mitigation[20]);
    console.log(data_90_mitigation[100]);
    plotChart();
  });

  function plotChart() {
    let myChart = document.getElementById(plot_id).getContext('2d');
    // Global Options
    Chart.defaults.global.defaultFontFamily = 'Lato';
    Chart.defaults.global.defaultFontSize = 18;
    Chart.defaults.global.defaultFontColor = '#777';

    let massPopChart = new Chart(myChart, {
      type: 'scatter', // bar, horizontalBar, pie, line, doughnut, radar, polarArea
      data:{
        datasets:[
          {
          label:'No mitigation',
          data: data_no_mitigation,
          borderColor:'red',
          borderWidth: 1,
          fill: false
          },
          {
          label:'50% mitigation',
          data: data_50_mitigation,
          borderColor:'yellow',
          borderWidth: 1,
          fill: false
          },
          {
          label:'75% mitigation',
          data: data_75_mitigation,
          borderColor:'blue',
          borderWidth: 1,
          fill: false
          },
          {
          label:'90% mitigation',
          data: data_90_mitigation,
          borderColor:'green',
          borderWidth: 1,
          fill: false
          },
        ]
      },
      options:{
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Days since 1st infection'
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Population (In Thousand)'
            }
          }]
        },
        title:{
          display:true,
          text:'Projected Covid-19 ' + name + '(' + region + ')',
          fontSize:25
        },
        legend:{
          display:true,
          position:'right',
          labels:{
            fontColor:'#000'
          }
        },
        layout:{
          padding:{
            left:50,
            right:0,
            bottom:0,
            top:0
          }
        },
        tooltips:{
          enabled:true
        }
      }
    });
  }
}
    </script>
  </body>
</html>
