<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.0/async.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
        <title>My Chart.js Chart</title>
    </head>
    <body>
        <div class="container">
            <canvas id="myChart"></canvas>
        </div>
        <div class="container">
            <canvas id="myChart2"></canvas>
        </div>
        <div class="container">
          <canvas id="myChart3"></canvas>
      </div>
      <div class="container">
          <canvas id="myChart4"></canvas>
      </div>
        <script>

    plotChartType('Infected', 'National', 'infected', 'myChart');
    plotChartType('Deaths', 'National', 'chilam', 'myChart2');
    plotChartType('DeathsPerDay', 'National', 'chilamPerDay', 'myChart3');
    plotChartType('Recovered', 'National', 'recovered', 'myChart4');

    function plotChartType(name, region, data_type_in_csv, plot_id){
      // Get national infected:
    var data_no_mitigation = [];
    var data_50_mitigation = [];
    var data_75_mitigation = [];
    var data_90_mitigation = [];

    function readCSV(name, store_at, callback) {
      console.log("called read csv");
      d3.csv(name).then(function(data) {
      data.forEach(function(d) {
        let x = +d.day;
        let y = +d[data_type_in_csv]/1000;
        store_at.push({x: x,y: y});
      });
      callback();
      });
   }
  
  async.parallel([
    function(callback) { readCSV('/scripts/data/'+region+'_No.csv', data_no_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_50.csv', data_50_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_75.csv', data_75_mitigation, callback); },
    function(callback) { readCSV('/scripts/data/'+region+'_90.csv', data_90_mitigation, callback); }
  ], function done(err, results) {
    console.log("loaded all csv");
    console.log(data_no_mitigation[20]);
    console.log(data_90_mitigation[100]);
    plotChart();
  });

  function plotChart() {
    let myChart = document.getElementById(plot_id).getContext('2d');
    // Global Options
    Chart.defaults.global.defaultFontFamily = 'Lato';
    Chart.defaults.global.defaultFontSize = 18;
    Chart.defaults.global.defaultFontColor = '#777';

    let massPopChart = new Chart(myChart, {
      type: 'scatter', // bar, horizontalBar, pie, line, doughnut, radar, polarArea
      data:{
        datasets:[
          {
          label:'No mitigation',
          data: data_no_mitigation,
          borderColor:'red',
          borderWidth: 1,
          },
          {
          label:'50% mitigation',
          data: data_50_mitigation,
          borderColor:'yellow',
          borderWidth: 1
          },
          {
          label:'75% mitigation',
          data: data_75_mitigation,
          borderColor:'blue',
          borderWidth: 1
          },
          {
          label:'90% mitigation',
          data: data_90_mitigation,
          borderColor:'green',
          borderWidth: 1
          },
        ]
      },
      options:{
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Days since 1st infection'
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Population (In Thousand)'
            }
          }]
        },
        title:{
          display:true,
          text:'Projected Covid-19 ' + name + '(' + region + ')',
          fontSize:25
        },
        legend:{
          display:true,
          position:'right',
          labels:{
            fontColor:'#000'
          }
        },
        layout:{
          padding:{
            left:50,
            right:0,
            bottom:0,
            top:0
          }
        },
        tooltips:{
          enabled:true
        }
      }
    });
  }
}
        </script>
    </body>
</html>
